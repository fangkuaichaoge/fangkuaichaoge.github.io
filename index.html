<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minecraft 4D皮肤包合并工具</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @font-face {
            font-family: 'Minecraft';
            src: local('Microsoft YaHei'), local('SimHei'), sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --mc-green: #3b8526;
            --mc-green-hover: #4a9b30;
            --mc-gray-light: #d0d1d5;
            --mc-bg-dark: #1b1b1b;
            --mc-bg-panel: #212121;
            --mc-bg-button: #404040;
            --mc-border: #000000;
            --mc-text-muted: #888888;
            --mc-red: #8b3a3a;
            --mc-red-hover: #a04545;
        }

        body {
            font-family: "Microsoft YaHei", sans-serif;
            background-color: var(--mc-bg-dark);
            color: var(--mc-gray-light);
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
            image-rendering: pixelated;
        }

        /* 左侧边栏 - Minecraft风格 */
        .sidebar {
            width: 80px;
            background-color: var(--mc-bg-panel);
            border-right: 4px solid var(--mc-border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            box-shadow: 4px 0 0 rgba(0,0,0,0.5);
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .logo {
            width: 48px;
            height: 48px;
            background-color: var(--mc-green);
            border: 3px solid var(--mc-border);
            border-bottom: 6px solid var(--mc-border);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--mc-gray-light);
            font-size: 20px;
            image-rendering: pixelated;
            box-shadow: inset 0 2px 0 rgba(255,255,255,0.2);
        }

        .version {
            margin-top: auto;
            color: var(--mc-text-muted);
            font-size: 12px;
            font-weight: 600;
            text-shadow: 2px 2px 0 #000;
        }

        .sidebar-btn {
            width: 48px;
            height: 48px;
            background-color: var(--mc-bg-button);
            border: 3px solid var(--mc-border);
            border-bottom: 6px solid var(--mc-border);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--mc-gray-light);
            font-size: 20px;
            margin: 16px 0;
            text-decoration: none;
            transition: all 0.1s;
            box-shadow: inset 0 2px 0 rgba(255,255,255,0.1);
        }

        .sidebar-btn:hover {
            background-color: var(--mc-green);
            transform: translateY(-2px);
        }

        .sidebar-btn:active {
            border-bottom: 4px solid var(--mc-border);
            transform: translateY(2px);
        }

        /* 主内容区 */
        .main-content {
            flex: 1;
            margin-left: 80px;
            padding: 30px;
            max-width: 1200px;
        }

        .page-header {
            margin-bottom: 24px;
            text-align: center;
            border-bottom: 3px solid var(--mc-border);
            padding-bottom: 16px;
            background-color: rgba(0,0,0,0.2);
            padding: 16px;
            border: 3px solid var(--mc-border);
            box-shadow: 0 4px 0 rgba(0,0,0,0.5);
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--mc-gray-light);
            display: inline-flex;
            align-items: center;
            gap: 12px;
            text-shadow: 2px 2px 0 #000;
        }

        .page-title i {
            color: var(--mc-green);
            font-size: 28px;
        }

        /* Minecraft风格卡片 */
        .glass-container {
            background-color: rgba(33, 33, 33, 0.9);
            border: 3px solid var(--mc-border);
            box-shadow: 0 6px 0 rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.1);
            padding: 24px;
            margin-bottom: 24px;
            position: relative;
        }

        .glass-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to bottom, rgba(255,255,255,0.1), transparent);
            pointer-events: none;
        }

        /* 上传区域 - MC风格 */
        .upload-section {
            margin-bottom: 20px;
        }

        .upload-zone {
            background-color: rgba(0,0,0,0.3);
            border: 3px dashed var(--mc-bg-button);
            border-radius: 0;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--mc-green);
            background-color: rgba(59, 133, 38, 0.1);
            box-shadow: inset 0 0 30px rgba(59, 133, 38, 0.2);
        }

        .upload-zone.dragover {
            border-style: solid;
            background-color: rgba(59, 133, 38, 0.2);
        }

        .upload-icon-main {
            width: 64px;
            height: 64px;
            background-color: var(--mc-bg-button);
            border: 3px solid var(--mc-border);
            border-bottom: 6px solid var(--mc-border);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            color: var(--mc-green);
            font-size: 28px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.5);
        }

        .upload-title-main {
            color: var(--mc-gray-light);
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 2px 2px 0 #000;
        }

        .upload-subtitle-main {
            color: var(--mc-text-muted);
            font-size: 13px;
        }

        .upload-hint {
            margin-top: 16px;
            padding: 8px 16px;
            background-color: rgba(59, 133, 38, 0.2);
            border: 2px solid var(--mc-green);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--mc-green);
            font-size: 12px;
            font-weight: 600;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.5);
        }

        /* 文件列表 */
        .packs-list-container {
            margin-top: 20px;
        }

        .section-subheader {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            color: var(--mc-gray-light);
            font-size: 15px;
            font-weight: 600;
            text-shadow: 2px 2px 0 #000;
        }

        .pack-count {
            background-color: var(--mc-green);
            color: var(--mc-gray-light);
            padding: 4px 12px;
            border: 2px solid var(--mc-border);
            border-bottom: 4px solid var(--mc-border);
            font-size: 12px;
            font-weight: 700;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
        }

        .packs-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 100px;
        }

        .pack-item {
            background-color: var(--mc-bg-button);
            border: 3px solid var(--mc-border);
            border-bottom: 6px solid var(--mc-border);
            display: flex;
            flex-direction: column;
            cursor: move;
            transition: all 0.1s;
            position: relative;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .pack-item:hover {
            border-color: var(--mc-green);
        }

        .pack-item.dragging {
            opacity: 0.6;
            border-color: var(--mc-green);
        }

        .pack-item.drag-over {
            border-top: 4px solid var(--mc-green);
            margin-top: 8px;
        }

        .pack-item.error {
            border-color: var(--mc-red);
        }

        .pack-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
        }

        .pack-handle {
            color: var(--mc-text-muted);
            font-size: 16px;
            cursor: grab;
            padding: 8px;
            margin: -8px;
        }

        .pack-handle:active {
            cursor: grabbing;
            color: var(--mc-green);
        }

        .pack-number {
            width: 32px;
            height: 32px;
            background-color: var(--mc-green);
            border: 2px solid var(--mc-border);
            border-bottom: 4px solid var(--mc-border);
            color: var(--mc-gray-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
        }

        .pack-info {
            flex: 1;
            min-width: 0;
        }

        .pack-name {
            color: var(--mc-gray-light);
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            text-shadow: 1px 1px 0 #000;
        }

        .pack-path {
            color: var(--mc-text-muted);
            font-size: 11px;
            margin-bottom: 4px;
        }

        .pack-meta {
            color: var(--mc-text-muted);
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pack-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background-color: rgba(59, 133, 38, 0.2);
            color: var(--mc-green);
            border: 1px solid var(--mc-green);
            font-size: 11px;
            font-weight: 600;
        }

        .pack-status.error {
            background-color: rgba(139, 58, 58, 0.2);
            color: #ff6b6b;
            border-color: var(--mc-red);
        }

        .pack-actions {
            display: flex;
            gap: 8px;
        }

        .pack-btn {
            width: 32px;
            height: 32px;
            border: 2px solid var(--mc-border);
            border-bottom: 4px solid var(--mc-border);
            background-color: var(--mc-bg-panel);
            color: var(--mc-gray-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
        }

        .pack-btn:hover {
            background-color: var(--mc-green);
            transform: translateY(-1px);
        }

        .pack-btn:active {
            border-bottom: 2px solid var(--mc-border);
            transform: translateY(2px);
        }

        .pack-btn.delete:hover {
            background-color: var(--mc-red);
        }

        .pack-btn.expand {
            width: auto;
            padding: 0 12px;
            font-size: 12px;
            gap: 4px;
        }

        .pack-btn.expand:hover {
            background-color: var(--mc-green);
        }

        /* 皮肤列表展开区域 */
        .skins-expandable {
            border-top: 2px solid var(--mc-border);
            background-color: rgba(0,0,0,0.3);
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .skins-expandable.expanded {
            max-height: 2000px;
            overflow-y: auto;
        }

        .skins-list {
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .skin-item {
            background-color: var(--mc-bg-panel);
            border: 2px solid var(--mc-border);
            border-bottom: 4px solid var(--mc-border);
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.1s;
        }

        .skin-item:hover {
            border-color: var(--mc-green);
            transform: translateX(4px);
        }

        .skin-index {
            width: 24px;
            height: 24px;
            background-color: var(--mc-bg-button);
            border: 2px solid var(--mc-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 700;
            color: var(--mc-text-muted);
            flex-shrink: 0;
        }

        .skin-details {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .skin-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--mc-gray-light);
            text-shadow: 1px 1px 0 #000;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .skin-geometry {
            font-size: 11px;
            color: var(--mc-text-muted);
            font-family: 'Consolas', monospace;
        }

        .skin-texture {
            font-size: 11px;
            color: var(--mc-green);
        }

        .skin-animations {
            font-size: 10px;
            color: var(--mc-text-muted);
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 2px;
        }

        .anim-tag {
            background-color: rgba(59, 133, 38, 0.2);
            padding: 2px 6px;
            border: 1px solid rgba(59, 133, 38, 0.5);
            border-radius: 2px;
        }

        .skin-flags {
            display: flex;
            gap: 6px;
            margin-top: 4px;
        }

        .flag-tag {
            font-size: 10px;
            padding: 2px 6px;
            background-color: var(--mc-bg-button);
            border: 1px solid var(--mc-border);
            color: var(--mc-text-muted);
        }

        .flag-tag.active {
            background-color: rgba(59, 133, 38, 0.3);
            color: var(--mc-green);
            border-color: var(--mc-green);
        }

        .skin-delete-btn {
            width: 28px;
            height: 28px;
            border: 2px solid var(--mc-border);
            border-bottom: 4px solid var(--mc-border);
            background-color: var(--mc-bg-button);
            color: var(--mc-gray-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
            flex-shrink: 0;
        }

        .skin-delete-btn:hover {
            background-color: var(--mc-red);
            transform: translateY(-1px);
        }

        .skin-delete-btn:active {
            border-bottom: 2px solid var(--mc-border);
            transform: translateY(2px);
        }

        .skin-delete-btn:disabled {
            background-color: var(--mc-bg-dark);
            color: var(--mc-text-muted);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .skin-delete-btn:disabled:hover {
            background-color: var(--mc-bg-dark);
        }

        /* 多选模式相关样式 */
        .skins-list-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background-color: var(--mc-bg-button);
            border: 2px solid var(--mc-border);
            border-bottom: 4px solid var(--mc-border);
            margin-bottom: 8px;
        }

        .skins-list-header-left {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--mc-text-muted);
            font-size: 12px;
            font-weight: 600;
            text-shadow: 1px 1px 0 #000;
        }

        .btn-multi-delete {
            padding: 6px 14px;
            background-color: var(--mc-red);
            border: 2px solid var(--mc-border);
            border-bottom: 4px solid var(--mc-border);
            color: var(--mc-gray-light);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.1s;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
        }

        .btn-multi-delete:hover:not(:disabled) {
            background-color: var(--mc-red-hover);
            transform: translateY(-1px);
        }

        .btn-multi-delete:active:not(:disabled) {
            border-bottom: 2px solid var(--mc-border);
            transform: translateY(2px);
        }

        .btn-multi-delete:disabled {
            background-color: var(--mc-bg-dark);
            color: var(--mc-text-muted);
            cursor: not-allowed;
            opacity: 0.5;
        }

        .btn-toggle-multi {
            padding: 6px 14px;
            background-color: var(--mc-bg-panel);
            border: 2px solid var(--mc-border);
            border-bottom: 4px solid var(--mc-border);
            color: var(--mc-gray-light);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.1s;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
        }

        .btn-toggle-multi:hover {
            background-color: var(--mc-green);
            transform: translateY(-1px);
        }

        .btn-toggle-multi.active {
            background-color: var(--mc-green);
            border-bottom: 2px solid var(--mc-border);
            transform: translateY(2px);
        }

        .skin-item.multi-selected {
            background-color: rgba(59, 133, 38, 0.2);
            border-color: var(--mc-green);
        }

        .skin-item .skin-checkbox-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            flex-shrink: 0;
        }

        .skin-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--mc-green);
        }

        /* 查看模型按钮 */
        .skin-view-btn {
            width: 28px;
            height: 28px;
            border: 2px solid var(--mc-border);
            border-bottom: 4px solid var(--mc-border);
            background-color: var(--mc-green);
            color: var(--mc-gray-light);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.1s;
            flex-shrink: 0;
            margin-right: 8px;
        }

        .skin-view-btn:hover {
            background-color: var(--mc-green-hover);
            transform: translateY(-1px);
        }

        .skin-view-btn:active {
            border-bottom: 2px solid var(--mc-border);
            transform: translateY(2px);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--mc-text-muted);
            font-size: 14px;
            background-color: rgba(0,0,0,0.2);
            border: 3px dashed var(--mc-bg-button);
        }

        /* 分段按钮组 - MC风格 */
        .section-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            color: var(--mc-gray-light);
            font-size: 16px;
            font-weight: 600;
            text-shadow: 2px 2px 0 #000;
        }

        .section-header i {
            color: var(--mc-green);
        }

        .preset-pills {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .preset-pill {
            padding: 10px 20px;
            background-color: var(--mc-bg-button);
            border: 3px solid var(--mc-border);
            border-bottom: 6px solid var(--mc-border);
            font-size: 13px;
            font-weight: 600;
            color: var(--mc-gray-light);
            cursor: pointer;
            transition: all 0.1s;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.1);
            text-shadow: 1px 1px 0 #000;
        }

        .preset-pill:hover {
            background-color: #4a4a4a;
            transform: translateY(-1px);
        }

        .preset-pill.active {
            background-color: var(--mc-green);
            color: var(--mc-gray-light);
            border-bottom: 4px solid var(--mc-border);
            transform: translateY(2px);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .preset-hint {
            font-size: 12px;
            color: var(--mc-text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
            padding-top: 12px;
            border-top: 2px solid var(--mc-bg-button);
        }

        /* 选项网格 */
        .options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            background-color: rgba(0,0,0,0.2);
            border: 3px solid var(--mc-border);
            border-bottom: 6px solid var(--mc-border);
            padding: 20px;
            margin-bottom: 20px;
        }

        .option-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            background-color: var(--mc-bg-button);
            border: 2px solid var(--mc-border);
            border-bottom: 4px solid var(--mc-border);
            transition: all 0.1s;
        }

        .option-item:hover {
            transform: translateX(2px);
            border-color: var(--mc-green);
        }

        .option-label {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--mc-gray-light);
            font-size: 13px;
            font-weight: 600;
            text-shadow: 1px 1px 0 #000;
        }

        .option-label i {
            color: var(--mc-green);
            width: 20px;
            text-align: center;
        }

        /* MC风格开关 */
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            cursor: pointer;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--mc-bg-dark);
            border: 2px solid var(--mc-border);
            transition: .2s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: var(--mc-text-muted);
            border: 2px solid var(--mc-border);
            transition: .2s;
            box-shadow: 0 2px 0 rgba(0,0,0,0.5);
        }

        input:checked + .slider {
            background-color: var(--mc-green);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
            background-color: var(--mc-gray-light);
        }

        /* 合并按钮 - MC风格大按钮 */
        .btn-merge {
            width: 100%;
            padding: 16px;
            background-color: var(--mc-green);
            color: var(--mc-gray-light);
            border: 3px solid var(--mc-border);
            border-bottom: 6px solid var(--mc-border);
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
            box-shadow: inset 0 2px 0 rgba(255,255,255,0.1);
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-merge:hover:not(:disabled) {
            background-color: var(--mc-green-hover);
            transform: translateY(-2px);
        }

        .btn-merge:active:not(:disabled) {
            border-bottom: 3px solid var(--mc-border);
            transform: translateY(4px);
        }

        .btn-merge:disabled {
            background-color: var(--mc-bg-button);
            color: var(--mc-text-muted);
            cursor: not-allowed;
            border-bottom: 4px solid var(--mc-border);
        }

        /* 进度条 */
        .progress-container {
            background-color: rgba(0,0,0,0.3);
            border: 3px solid var(--mc-border);
            border-bottom: 6px solid var(--mc-border);
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .progress-bar-bg {
            height: 20px;
            background-color: var(--mc-bg-dark);
            border: 2px solid var(--mc-border);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--mc-green);
            width: 0%;
            transition: width 0.3s;
            box-shadow: inset 0 2px 0 rgba(255,255,255,0.2);
            position: relative;
        }

        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                90deg,
                transparent,
                transparent 10px,
                rgba(0,0,0,0.1) 10px,
                rgba(0,0,0,0.1) 20px
            );
            animation: slide 1s linear infinite;
        }

        @keyframes slide {
            0% { transform: translateX(-20px); }
            100% { transform: translateX(0); }
        }

        .progress-text {
            color: var(--mc-gray-light);
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            text-shadow: 1px 1px 0 #000;
        }

        .progress-text i {
            animation: spin 1s linear infinite;
            color: var(--mc-green);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 结果区域 */
        .result-container {
            background-color: rgba(59, 133, 38, 0.1);
            border: 3px solid var(--mc-green);
            border-bottom: 6px solid var(--mc-border);
            padding: 24px;
            text-align: center;
            display: none;
            margin-bottom: 20px;
        }

        .result-icon {
            width: 56px;
            height: 56px;
            background-color: var(--mc-green);
            border: 3px solid var(--mc-border);
            border-bottom: 6px solid var(--mc-border);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: var(--mc-gray-light);
            font-size: 24px;
            margin-bottom: 12px;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
        }

        .result-title {
            color: var(--mc-gray-light);
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            text-shadow: 2px 2px 0 #000;
        }

        .btn-download {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 28px;
            background-color: var(--mc-green);
            color: var(--mc-gray-light);
            text-decoration: none;
            border: 3px solid var(--mc-border);
            border-bottom: 6px solid var(--mc-border);
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.1s;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.3);
        }

        .btn-download:hover {
            background-color: var(--mc-green-hover);
            transform: translateY(-2px);
        }

        .btn-download:active {
            border-bottom: 3px solid var(--mc-border);
            transform: translateY(4px);
        }

        /* 日志区域 */
        .log-container {
            background-color: rgba(0,0,0,0.5);
            border: 3px solid var(--mc-border);
            border-bottom: 6px solid var(--mc-border);
            padding: 16px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .log-header {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--mc-green);
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--mc-bg-button);
            text-shadow: 1px 1px 0 rgba(0,0,0,0.5);
            position: sticky;
            top: 0;
            background-color: rgba(0,0,0,0.8);
            z-index: 10;
        }

        .log-content {
            font-size: 12px;
            line-height: 1.6;
            color: var(--mc-gray-light);
        }

        .log-content div {
            padding: 2px 0;
            border-left: 2px solid var(--mc-green);
            padding-left: 8px;
            margin-bottom: 4px;
        }

        .log-content div::before {
            content: '>';
            color: var(--mc-green);
            margin-right: 6px;
            font-weight: bold;
        }

        /* 模型预览内联区域 */
        .model-viewer-inline {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            border-top: 2px solid var(--mc-border);
            background-color: rgba(0,0,0,0.3);
        }

        .model-viewer-inline.expanded {
            max-height: 500px;
            overflow: visible;
        }

        .model-viewer-inline-content {
            padding: 16px;
        }

        .model-viewer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            color: var(--mc-gray-light);
            font-size: 14px;
            font-weight: 600;
            text-shadow: 2px 2px 0 #000;
        }

        .model-viewer-header i {
            color: var(--mc-green);
        }

        .model-viewer-canvas {
            height: 300px;
            background: #1a1a2e;
            position: relative;
            overflow: hidden;
            border: 2px solid var(--mc-border);
            border-bottom: 4px solid var(--mc-border);
        }

        /* 滚动条 - MC风格 */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--mc-bg-dark);
            border: 2px solid var(--mc-border);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--mc-bg-button);
            border: 2px solid var(--mc-border);
            border-bottom: 4px solid var(--mc-border);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--mc-green);
        }

        /* 响应式 */
        @media (max-width: 1024px) {
            .options-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 56px;
            }
            .logo {
                width: 36px;
                height: 36px;
            }
            .main-content {
                margin-left: 56px;
                padding: 20px;
            }
            .options-grid {
                grid-template-columns: 1fr;
            }
            .upload-zone {
                padding: 30px 20px;
            }
            .model-viewer-canvas {
                height: 250px;
            }
        }

        /* 移动端适配 - 手机竖屏 */
        @media (max-width: 600px) {
            .sidebar {
                display: none;
            }
            .main-content {
                margin-left: 0;
                padding: 12px;
                padding-bottom: 80px;
            }
            .page-header {
                padding: 12px;
            }
            .page-title {
                font-size: 18px;
            }
            .glass-container {
                padding: 16px;
                margin-bottom: 16px;
            }
            .section-header {
                font-size: 14px;
                margin-bottom: 12px;
            }
            .upload-zone {
                padding: 24px 16px;
            }
            .upload-icon-main {
                width: 48px;
                height: 48px;
                font-size: 22px;
            }
            .upload-title-main {
                font-size: 15px;
            }
            .upload-subtitle-main {
                font-size: 12px;
            }
            
            /* 预设按钮优化 - 两列布局 */
            .preset-pills {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            .preset-pill {
                padding: 12px 8px;
                font-size: 12px;
                text-align: center;
            }
            .preset-pill.active {
                border-bottom-width: 4px;
            }
            .preset-hint {
                font-size: 11px;
                flex-wrap: wrap;
            }
            
            /* 选项网格 - 单列紧凑布局 */
            .options-grid {
                grid-template-columns: 1fr;
                gap: 8px;
                padding: 12px;
            }
            .option-item {
                padding: 10px 12px;
            }
            .option-label {
                font-size: 12px;
            }
            .option-label i {
                display: none;
            }
            .toggle-switch {
                width: 40px;
                height: 22px;
            }
            .slider:before {
                height: 14px;
                width: 14px;
            }
            input:checked + .slider:before {
                transform: translateX(18px);
            }
            
            /* 合并按钮 */
            .btn-merge {
                padding: 14px;
                font-size: 14px;
            }
            
            /* 包列表项 */
            .pack-header {
                padding: 10px 12px;
                gap: 10px;
            }
            .pack-number {
                width: 28px;
                height: 28px;
                font-size: 12px;
            }
            .pack-name {
                font-size: 13px;
            }
            .pack-meta {
                font-size: 10px;
                flex-wrap: wrap;
            }
            .pack-actions {
                gap: 6px;
            }
            .pack-btn {
                width: 28px;
                height: 28px;
            }
            
            /* 皮肤列表项 */
            .skin-item {
                padding: 8px 10px;
            }
            .skin-name {
                font-size: 12px;
            }
            .skin-geometry, .skin-texture {
                font-size: 10px;
            }
            .skin-view-btn, .skin-delete-btn {
                width: 24px;
                height: 24px;
                font-size: 11px;
            }
            
            /* 进度条 */
            .progress-container {
                padding: 16px;
            }
            .progress-bar-bg {
                height: 16px;
            }
            .progress-text {
                font-size: 12px;
            }
            
            /* 结果区域 */
            .result-icon {
                width: 44px;
                height: 44px;
                font-size: 20px;
            }
            .result-title {
                font-size: 16px;
            }
            .btn-download {
                padding: 12px 20px;
                font-size: 13px;
            }
            
            /* 日志区域 */
            .log-container {
                padding: 12px;
                max-height: 200px;
            }
            .log-header {
                font-size: 12px;
            }
            .log-content {
                font-size: 11px;
            }
            
            /* 皮肤展开区域 */
            .skins-list-header {
                flex-wrap: wrap;
                gap: 8px;
                padding: 8px 10px;
            }
            .skins-list-header-left {
                font-size: 11px;
            }
            .btn-multi-delete, .btn-toggle-multi {
                padding: 6px 10px;
                font-size: 11px;
            }
        }

        /* 超窄屏幕适配 */
        @media (max-width: 400px) {
            .main-content {
                padding: 10px;
                padding-bottom: 70px;
            }
            .page-title {
                font-size: 16px;
            }
            .preset-pills {
                grid-template-columns: 1fr;
            }
            .preset-pill {
                padding: 10px 8px;
            }
            .glass-container {
                padding: 12px;
            }
            .upload-zone {
                padding: 20px 12px;
            }
            .upload-icon-main {
                width: 40px;
                height: 40px;
                font-size: 18px;
            }
            .upload-title-main {
                font-size: 14px;
            }
            .option-item {
                padding: 8px 10px;
            }
            .option-label {
                font-size: 11px;
            }
            .btn-merge {
                padding: 12px;
                font-size: 13px;
            }
        }
    </style>
    <script src="./js/jszip.min.js"></script>
            <script src="./js/FileSaver.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
</head>

<body>
    <aside class="sidebar">
        <div class="logo">
            <i class="fas fa-layer-group"></i>
        </div>
        <a href="skinstudio/index.html" class="sidebar-btn" title="打开 SkinStudio">
            <i class="fas fa-palette"></i>
        </a>
        <div class="version">v3.0</div>
    </aside>

    <main class="main-content">
        <div class="page-header">
            <h1 class="page-title">
                <i class="fas fa-layer-group"></i>
                Minecraft 4D皮肤包合并工具
            </h1>
        </div>

        <!-- 上传区域 -->
        <div class="glass-container">
            <div class="upload-section">
                <div class="upload-zone" id="uploadZone">
                    <div class="upload-icon-main">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-title-main">点击或拖拽上传皮肤包</div>
                    <div class="upload-subtitle-main">支持多选ZIP文件，可多次添加</div>
                    <div class="upload-hint">
                        <i class="fas fa-lightbulb"></i>
                        <span>自动识别多级文件夹结构</span>
                    </div>
                    <input type="file" id="fileInput" style="display: none;" accept=".zip" multiple>
                </div>
            </div>

            <!-- 已上传列表 -->
            <div class="packs-list-container" id="packsListContainer" style="display: none;">
                <div class="section-subheader">
                    <span>已上传的皮肤包 <span style="color: #888; font-size: 13px; font-weight: normal;">（拖拽可调整合并顺序，点击展开查看皮肤列表）</span></span>
                    <span class="pack-count" id="packCount">0 个</span>
                </div>
                <div class="packs-list" id="packsList"></div>
            </div>

            <div class="empty-state" id="emptyState">
                <i class="fas fa-box-open" style="font-size: 32px; margin-bottom: 8px; display: block; opacity: 0.5;"></i>
                <div>暂无皮肤包，请上传文件</div>
            </div>
        </div>

        <!-- 预设配置 -->
        <div class="glass-container">
            <div class="section-header">
                <i class="fas fa-magic"></i>
                <span>配置预设</span>
            </div>
            <div class="preset-pills">
                <button class="preset-pill" data-preset="1">皮肤/模型兼容</button>
                <button class="preset-pill" data-preset="2">启动器适配</button>
                <button class="preset-pill" data-preset="3">皮肤名简化</button>
                <button class="preset-pill" data-preset="4">小白全能版</button>
            </div>
            <div class="preset-hint">
                <i class="fas fa-info-circle"></i>
                <span>点击预设可快速配置常用选项组合，可与手动设置叠加使用</span>
            </div>
        </div>

        <!-- 选项区域 -->
        <div class="glass-container">
            <div class="section-header" style="margin-top: -8px;">
                <i class="fas fa-sliders-h"></i>
                <span>高级设置</span>
            </div>
            <div class="options-grid">
                <div class="option-item">
                    <div class="option-label">
                        <i class="fas fa-clone"></i>
                        <span>重名模型兼容</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="compatibleRenameModel">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="option-item">
                    <div class="option-label">
                        <i class="fas fa-font"></i>
                        <span>命名简化</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="simplifyNaming">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="option-item">
                    <div class="option-label">
                        <i class="fas fa-fingerprint"></i>
                        <span>UUID替换</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="replaceUuid">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="option-item">
                    <div class="option-label">
                        <i class="fas fa-tshirt"></i>
                        <span>隐藏盔甲</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="addHideArmor">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="option-item">
                    <div class="option-label">
                        <i class="fas fa-globe"></i>
                        <span>国外作者皮肤包适配</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="fixComments">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="option-item">
                    <div class="option-label">
                        <i class="fas fa-box-open"></i>
                        <span>输出为mcpack</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="outputMcpack">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>

        <button class="btn-merge" id="mergeBtn" disabled>
            <i class="fas fa-code-branch"></i>
            <span id="mergeBtnText">开始合并皮肤包</span>
        </button>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar-bg">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">
                <i class="fas fa-spinner"></i>
                准备合并...
            </div>
        </div>

        <div class="result-container" id="resultContainer">
            <div class="result-icon">
                <i class="fas fa-check"></i>
            </div>
            <div class="result-title">合并成功！</div>
            <button class="btn-download" id="downloadBtn">
                <i class="fas fa-download"></i>
                下载合并后的皮肤包
            </button>
        </div>

        <div class="glass-container" style="padding: 0; overflow: hidden;">
            <div class="log-container" id="log">
                <div class="log-header">
                    <i class="fas fa-terminal"></i>
                    <span>处理日志</span>
                </div>
                <div class="log-content" id="logContent"></div>
            </div>
        </div>
    </main>

    

    <script>
        (() => {
            'use strict';

            // 常量定义
            const CORE_FILES = ['manifest.json', 'geometry.json', 'skins.json'];
            const PRESET_CONFIGS = {
                1: { name: "同模型兼容", settings: { compatibleRenameModel: true, fixComments: true } },
                2: { name: "启动器适配", settings: { replaceUuid: true, outputMcpack: true } },
                3: { name: "简化合并", settings: { simplifyNaming: true, addHideArmor: true } },
                4: { name: "全能版", settings: { compatibleRenameModel: true, simplifyNaming: true, replaceUuid: true, addHideArmor: true, fixComments: true } }
            };

            // 状态管理
            const state = {
                skinPacks: [],
                mergeInProgress: false,
                dragStartIndex: null,
                modelTextureRelations: new Map()
            };

            // DOM 元素缓存
            const elements = {
                uploadZone: document.getElementById('uploadZone'),
                fileInput: document.getElementById('fileInput'),
                packsListContainer: document.getElementById('packsListContainer'),
                packsList: document.getElementById('packsList'),
                emptyState: document.getElementById('emptyState'),
                packCount: document.getElementById('packCount'),
                mergeBtn: document.getElementById('mergeBtn'),
                mergeBtnText: document.getElementById('mergeBtnText'),
                progressFill: document.getElementById('progressFill'),
                progressText: document.getElementById('progressText'),
                progressContainer: document.getElementById('progressContainer'),
                resultContainer: document.getElementById('resultContainer'),
                downloadBtn: document.getElementById('downloadBtn'),
                logContent: document.getElementById('logContent'),
                log: document.getElementById('log'),
                fixComments: document.getElementById('fixComments'),
                compatibleRenameModel: document.getElementById('compatibleRenameModel'),
                simplifyNaming: document.getElementById('simplifyNaming'),
                replaceUuid: document.getElementById('replaceUuid'),
                addHideArmor: document.getElementById('addHideArmor'),
                outputMcpack: document.getElementById('outputMcpack')
            };

            // 工具函数
            const utils = {
                generateUUID: () => 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                    const r = Math.random() * 16 | 0;
                    return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
                }),

                getSafeFileName: name => name.replace(/[\\/:*?"<>|]/g, '_').trim(),

                removeComments: jsonStr => jsonStr.replace(/(".*?")|(\/\/.*)/g, (match, str) => str || '').replace(/^\s*[\r\n]/gm, '').trim(),

                fixJsonSyntax: jsonStr => jsonStr
                    .replace(/,\s*}/g, '}')
                    .replace(/,\s*]/g, ']')
                    .replace(/(?<!\\)'/g, '"')
                    .replace(/([{,]\s*)(\w+)(\s*:)/g, '$1"$2"$3'),

                removeCommentsAndFixGeometry: jsonStr => {
                    let cleaned = utils.removeComments(jsonStr);
                    return cleaned.replace(/,\s*"geometry\.null"\s*:\s*\{\s*\}/g, '').replace(/"geometry\.null"\s*:\s*\{\s*\},?/g, '');
                },

                countSkins: content => {
                    try {
                        const data = JSON.parse(content);
                        return data.skins?.length || 0;
                    } catch {
                        return 0;
                    }
                },

                updateProgress: (percent, text) => {
                    elements.progressFill.style.width = `${percent}%`;
                    elements.progressText.innerHTML = `<i class="fas fa-spinner"></i> ${text}`;
                }
            };

            // 日志系统
            const logger = {
                add: text => {
                    const div = document.createElement('div');
                    div.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
                    elements.logContent.appendChild(div);
                    elements.log.scrollTop = elements.log.scrollHeight;
                },
                clear: () => {
                    elements.logContent.innerHTML = '';
                }
            };

            // 皮肤删除处理器 - 智能处理JSON逗号
            const skinDeleter = {
                deleteSkin(packId, skinIndex) {
                    const pack = state.skinPacks.find(p => p.id === packId);
                    if (!pack || !pack.files['skins.json']) return false;

                    const skinsContent = pack.files['skins.json']._content;
                    const skinsData = JSON.parse(skinsContent);
                    
                    if (skinsData.skins.length <= 1) {
                        logger.add(`⚠️ 无法删除：${pack.fileName} 至少需要保留1个皮肤`);
                        return false;
                    }

                    if (skinIndex < 0 || skinIndex >= skinsData.skins.length) return false;

                    // 获取要删除的皮肤信息
                    const deletedSkin = skinsData.skins[skinIndex];
                    const newSkins = skinsData.skins.filter((_, idx) => idx !== skinIndex);
                    
                    // 重建JSON字符串，智能处理逗号
                    const newJsonString = this.rebuildSkinsJson(skinsContent, skinsData.skins, skinIndex);
                    
                    // 更新文件内容
                    pack.files['skins.json']._content = newJsonString;
                    pack.skinCount = newSkins.length;
                    
                    // 如果该皮肤有专属贴图且不再被使用，标记为待删除
                    this.cleanupUnusedTexture(pack, deletedSkin.texture, newSkins);

                    logger.add(`🗑️ 已删除皮肤: ${deletedSkin.localization_name || `skin_${skinIndex}`} (${pack.fileName})`);
                    return true;
                },

                rebuildSkinsJson(originalContent, skins, deleteIndex) {
                    // 解析原始JSON字符串以准确定位
                    const data = JSON.parse(originalContent);
                    const skinArray = data.skins;
                    
                    // 构建新的skins数组
                    const newSkins = skinArray.filter((_, idx) => idx !== deleteIndex);
                    
                    // 重建整个JSON对象
                    const newData = { ...data, skins: newSkins };
                    
                    // 格式化输出，确保格式严谨
                    return JSON.stringify(newData);
                },

                cleanupUnusedTexture(pack, textureName, remainingSkins) {
                    const textureLower = textureName.toLowerCase();
                    const stillInUse = remainingSkins.some(s => s.texture.toLowerCase() === textureLower);
                    
                    if (!stillInUse && pack.files[textureLower]) {
                        // 标记贴图为未使用（实际删除在合并时处理）
                        pack.files[textureLower]._unused = true;
                        logger.add(`   📎 贴图 ${textureName} 不再被使用`);
                    }
                }
            };

            // 文件处理模块
            const fileHandler = {
                async extractZip(zipFile, pack) {
                    const zip = await JSZip.loadAsync(zipFile);
                    const allFiles = Object.entries(zip.files)
                        .filter(([, file]) => !file.dir)
                        .map(([path, file]) => ({ path, file, lowerPath: path.toLowerCase() }));

                    const coreFilesLocation = this.detectCoreFilesLocation(allFiles);
                    pack.rootPath = coreFilesLocation;

                    for (const { path, file } of allFiles) {
                        const textContent = await file.async('text');
                        const mappedFileName = this.mapFileName(path, coreFilesLocation);

                        pack.files[mappedFileName] = {
                            blob: await file.async('blob'),
                            name: mappedFileName,
                            originalPath: path,
                            _content: textContent,
                            get content() { return Promise.resolve(this._content); }
                        };
                    }
                },

                detectCoreFilesLocation(files) {
                    const findFile = name => files.find(f => f.lowerPath === name || f.lowerPath.endsWith(`/${name}`));
                    
                    const manifest = findFile('manifest.json');
                    const geometry = findFile('geometry.json');
                    const skins = findFile('skins.json');

                    if (manifest && geometry && skins) {
                        const idx = manifest.path.lastIndexOf('/');
                        return idx > 0 ? manifest.path.substring(0, idx + 1) : '';
                    }

                    const folderScores = {};
                    files.forEach(({ path, lowerPath }) => {
                        if (['manifest.json', 'geometry.json', 'skins.json'].some(f => lowerPath.endsWith(f))) {
                            const folder = path.substring(0, path.lastIndexOf('/') + 1);
                            folderScores[folder] = (folderScores[folder] || 0) + 1;
                        }
                    });

                    const bestFolder = Object.entries(folderScores).sort((a, b) => b[1] - a[1])[0];
                    return bestFolder && bestFolder[1] >= 3 ? bestFolder[0] : '';
                },

                mapFileName(path, corePath) {
                    const fileName = path.split('/').pop().toLowerCase();
                    const coreFiles = ['manifest.json', 'geometry.json', 'skins.json'];
                    
                    if (path.startsWith(corePath)) {
                        return coreFiles.includes(fileName) ? fileName : path.substring(corePath.length).toLowerCase();
                    }
                    return path.toLowerCase();
                },

                async loadCore(files, packName) {
                    const coreData = {};
                    
                    for (const fileName of CORE_FILES) {
                        const file = files[fileName];
                        if (!file) throw new Error(`${packName} 缺少 ${fileName}`);
                        
                        let content = file._content;
                        if (elements.fixComments.checked) {
                            logger.add(`🌍 国外作者适配：清理 ${packName} 的 ${fileName}`);
                            content = utils.removeCommentsAndFixGeometry(content);
                        }
                        
                        try {
                            coreData[fileName] = JSON.parse(content);
                        } catch {
                            try {
                                coreData[fileName] = JSON.parse(utils.fixJsonSyntax(content));
                                logger.add(`✅ ${fileName} 自动修复成功`);
                            } catch (e) {
                                throw new Error(`${fileName} JSON解析失败且无法自动修复：${e.message}`);
                            }
                        }

                        if (fileName === 'geometry.json' && coreData[fileName]?.['geometry.null']) {
                            delete coreData[fileName]['geometry.null'];
                            logger.add(`🗑️ 已移除 geometry.null 空定义（国外作者包适配）`);
                        }
                    }
                    
                    return coreData;
                }
            };

            // 模型-贴图关系扫描
            const relationScanner = {
                scan(coreData, packId) {
                    const relations = {
                        modelToTextures: new Map(),
                        textureToModels: new Map(),
                        skinToModel: new Map(),
                        skinToTexture: new Map()
                    };

                    const skins = coreData['skins.json']?.skins;
                    if (!skins) return relations;

                    skins.forEach((skin, idx) => {
                        const skinName = skin.localization_name || `skin_${idx}`;
                        const modelName = skin.geometry;
                        const textureName = skin.texture.toLowerCase();

                        relations.skinToModel.set(skinName, modelName);
                        relations.skinToTexture.set(skinName, textureName);

                        this.addToMap(relations.modelToTextures, modelName, textureName);
                        this.addToMap(relations.textureToModels, textureName, modelName);
                    });

                    // 转换为数组
                    for (const map of [relations.modelToTextures, relations.textureToModels]) {
                        for (const [key, val] of map) map.set(key, Array.from(val));
                    }

                    state.modelTextureRelations.set(packId, relations);
                    this.logRelations(relations);
                    return relations;
                },

                addToMap(map, key, value) {
                    if (!map.has(key)) map.set(key, new Set());
                    map.get(key).add(value);
                },

                logRelations(r) {
                    logger.add(`🔍 扫描皮肤包关联关系：`);
                    logger.add(`   - 模型数：${r.modelToTextures.size} | 贴图数：${r.textureToModels.size} | 皮肤数：${r.skinToModel.size}`);

                    for (const [model, textures] of r.modelToTextures) {
                        if (textures.length > 1) logger.add(`   ⚠️ 模型【${model}】关联多个贴图：${textures.join(', ')}`);
                    }
                    for (const [texture, models] of r.textureToModels) {
                        if (models.length > 1) logger.add(`   ⚠️ 贴图【${texture}】关联多个模型：${models.join(', ')}`);
                    }
                }
            };

            // 命名处理器
            const namingHandler = {
                compatibleSimplify(core, packId, startIndex) {
                    const relations = state.modelTextureRelations.get(packId);
                    if (!relations) return { skins: [], geoRenameMap: new Map(), textureMap: new Map() };

                    const modelHasMultiTextures = new Map();
                    const textureHasMultiModels = new Map();
                    const modelTextureSuffixMap = new Map();

                    // 分析多重关联
                    for (const [model, textures] of relations.modelToTextures) {
                        if (textures.length > 1) {
                            modelHasMultiTextures.set(model, textures);
                            modelTextureSuffixMap.set(model, new Map(textures.map((t, i) => [t, i === 0 ? '' : `_${i + 1}`])));
                        }
                    }
                    for (const [texture, models] of relations.textureToModels) {
                        if (models.length > 1) textureHasMultiModels.set(texture, models);
                    }

                    const modelNewNameMap = new Map();
                    const textureNewNameMap = new Map();
                    let baseIndex = startIndex;

                    // 处理单一关联
                    for (const [model] of relations.modelToTextures) {
                        if (!modelHasMultiTextures.has(model) && !this.hasMultiModels(textureHasMultiModels, model)) {
                            if (!modelNewNameMap.has(model)) {
                                const newName = `geometry.skin${baseIndex}`;
                                modelNewNameMap.set(model, newName);
                                
                                const textures = relations.modelToTextures.get(model);
                                if (textures.length === 1) {
                                    textureNewNameMap.set(textures[0], `skin${baseIndex}.png`);
                                }
                                baseIndex++;
                            }
                        }
                    }

                    // 处理多贴图模型
                    for (const [model, textures] of modelHasMultiTextures) {
                        if (!modelNewNameMap.has(model)) {
                            const newName = `geometry.skin${baseIndex}`;
                            modelNewNameMap.set(model, newName);
                            
                            textures.forEach((texture, idx) => {
                                if (!textureNewNameMap.has(texture)) {
                                    const suffix = idx === 0 ? '' : `_${idx + 1}`;
                                    textureNewNameMap.set(texture, `skin${baseIndex}${suffix}.png`);
                                }
                            });
                            baseIndex++;
                        }
                    }

                    // 处理多模型贴图
                    for (const [texture, models] of textureHasMultiModels) {
                        if (!textureNewNameMap.has(texture)) {
                            textureNewNameMap.set(texture, `skin${baseIndex}.png`);
                        }
                        const baseName = textureNewNameMap.get(texture).replace('.png', '');

                        models.forEach((model, idx) => {
                            if (!modelNewNameMap.has(model)) {
                                const suffix = idx === 0 ? '' : `_${idx + 1}`;
                                modelNewNameMap.set(model, `geometry.${baseName}${suffix}`);
                            }
                        });
                        baseIndex++;
                    }

                    return this.buildResult(core, relations, modelNewNameMap, textureNewNameMap, modelTextureSuffixMap);
                },

                hasMultiModels(textureHasMultiModels, model) {
                    return Array.from(textureHasMultiModels.values()).some(models => models.includes(model));
                },

                buildResult(core, relations, modelMap, textureMap, suffixMap) {
                    const modifiedSkins = [];
                    const geoRenameMap = new Map();
                    const textureRenameMap = new Map();

                    modelMap.forEach((newName, oldName) => geoRenameMap.set(oldName, newName));
                    textureMap.forEach((newName, oldName) => textureRenameMap.set(oldName, newName));

                    core['skins.json'].skins.forEach((skin, idx) => {
                        const skinName = skin.localization_name || `skin_${idx}`;
                        const oldModel = skin.geometry;
                        const oldTexture = relations.skinToTexture.get(skinName);

                        // 如果是 humanoid.custom 或 humanoid.customSlim，保持 geometry 不变
                        const isCustomHumanoid = oldModel === 'geometry.humanoid.custom' || oldModel === 'geometry.humanoid.customSlim';
                        const newModel = isCustomHumanoid ? oldModel : (modelMap.get(oldModel) || oldModel);
                        const newTexture = textureMap.get(oldTexture) || oldTexture;

                        let newSkinName = isCustomHumanoid ? skinName : newModel.replace('geometry.', '');
                        if (!isCustomHumanoid && suffixMap.has(oldModel) && suffixMap.get(oldModel).has(oldTexture)) {
                            newSkinName += suffixMap.get(oldModel).get(oldTexture);
                        }

                        modifiedSkins.push({ ...skin, localization_name: newSkinName, geometry: newModel, texture: newTexture });
                        logger.add(`🔄 兼容重命名：皮肤【${skinName}】→【${newSkinName}】`);
                    });

                    return { modifiedSkins, geoRenameMap, textureMap: textureRenameMap };
                },

                simplifySingle(core, packId, startIndex) {
                    const modifiedSkins = [];
                    const geoRenameMap = new Map();
                    const textureMap = new Map();

                    core['skins.json']?.skins?.forEach((skin, idx) => {
                        const baseName = `skin${startIndex + idx}`;
                        
                        // 如果是 humanoid.custom 或 humanoid.customSlim，保持 geometry 和名称不变
                        const isCustomHumanoid = skin.geometry === 'geometry.humanoid.custom' || skin.geometry === 'geometry.humanoid.customSlim';
                        
                        if (isCustomHumanoid) {
                            geoRenameMap.set(skin.geometry, skin.geometry);
                            textureMap.set(skin.texture.toLowerCase(), skin.texture.toLowerCase());
                            modifiedSkins.push({ ...skin });
                            logger.add(`✅ 保留自定义模型：${skin.localization_name}`);
                        } else {
                            const newGeo = `geometry.${baseName}`;
                            const newTex = `${baseName}.png`;

                            geoRenameMap.set(skin.geometry, newGeo);
                            textureMap.set(skin.texture.toLowerCase(), newTex);

                            modifiedSkins.push({ ...skin, localization_name: baseName, geometry: newGeo, texture: newTex });
                            logger.add(`🔄 简化命名：${skin.localization_name} → ${baseName}`);
                        }
                    });

                    return { modifiedSkins, geoRenameMap, textureMap };
                },

                modifyDuplicate(core, existingSkins, packPrefix) {
                    const existingNames = new Set(existingSkins.map(s => s.localization_name));
                    const existingGeo = new Set(existingSkins.map(s => s.geometry));

                    const modifiedSkins = [];
                    const geoRenameMap = new Map();
                    const textureMap = new Map();

                    core['skins.json']?.skins?.forEach(skin => {
                        let newName = skin.localization_name;
                        let newGeo = skin.geometry;
                        let newTex = skin.texture.toLowerCase();

                        // 如果是 humanoid.custom 或 humanoid.customSlim，保持 geometry 和名称不变
                        const isCustomHumanoid = skin.geometry === 'geometry.humanoid.custom' || skin.geometry === 'geometry.humanoid.customSlim';
                        
                        if (!isCustomHumanoid) {
                            if (existingNames.has(newName)) newName += `_${packPrefix}`;
                            if (existingGeo.has(newGeo)) newGeo += `_${packPrefix}`;

                            existingNames.add(newName);
                            existingGeo.add(newGeo);
                        }

                        geoRenameMap.set(skin.geometry, newGeo);
                        textureMap.set(skin.texture.toLowerCase(), newTex);
                        modifiedSkins.push({ ...skin, localization_name: newName, geometry: newGeo, texture: newTex });
                    });

                    return { modifiedSkins, geoRenameMap, textureMap };
                }
            };

            // ========== 模型预览功能 ==========
            window.ModelViewer = {
                scene: null,
                camera: null,
                renderer: null,
                currentMesh: null,
                currentTexture: null,
                isOpen: false,
                
                // 从pack.files中解析geometry数据
                parseGeometry(data) {
                    const result = {};

                    // 处理标准格式：minecraft:geometry 数组
                    if (data['minecraft:geometry'] && Array.isArray(data['minecraft:geometry'])) {
                        data['minecraft:geometry'].forEach(item => {
                            if (item.description && item.description.identifier) {
                                result[item.description.identifier] = item;
                            } else {
                                Object.entries(item).forEach(([key, value]) => {
                                    if (key.startsWith('geometry.')) {
                                        result[key] = value;
                                    }
                                });
                            }
                        });
                    }

                    // 处理直接使用 geometry.xxx 格式的数据（如 geometry.unknown）
                    Object.entries(data).forEach(([key, value]) => {
                        if (key.startsWith('geometry.') && !result[key]) {
                            result[key] = value;
                        }
                    });

                    return result;
                },

                // 修复JSON语法
                fixJsonSyntax(jsonText) {
                    let fixed = jsonText;
                    fixed = fixed.replace(/\/\*[\s\S]*?\*\//g, '');
                    fixed = fixed.replace(/\/\/.*$/gm, '');
                    fixed = fixed.replace(/,\s*([}\]])/g, '$1');
                    fixed = fixed.replace(/^\s*\n/gm, '');
                    return fixed;
                },

                // 生成立方体几何体（纯净坐标版，无Pivot变换）
                generateCubeGeometry(cube, texW, texH) {
                    const [ox, oy, oz] = cube.origin || [0, 0, 0];
                    const [sx, sy, sz] = cube.size || [1, 1, 1];
                    const [uvx, uvy] = cube.uv || [0, 0];
                    const inflate = cube.inflate || 0;

                    const inf = inflate;
                    const verts = [
                        [ox - inf, oy - inf, oz + sz + inf],
                        [ox + sx + inf, oy - inf, oz + sz + inf],
                        [ox + sx + inf, oy + sy + inf, oz + sz + inf],
                        [ox - inf, oy + sy + inf, oz + sz + inf],
                        [ox - inf, oy - inf, oz - inf],
                        [ox + sx + inf, oy - inf, oz - inf],
                        [ox + sx + inf, oy + sy + inf, oz - inf],
                        [ox - inf, oy + sy + inf, oz - inf]
                    ];

                    const faces = [
                        { verts: [5, 1, 2, 6], u: uvx + sz + sx, v: uvy + sz, w: sz, h: sy },
                        { verts: [0, 4, 7, 3], u: uvx, v: uvy + sz, w: sz, h: sy },
                        { verts: [4, 5, 6, 7], u: uvx + sz, v: uvy, w: sx, h: sz },
                        { verts: [1, 0, 3, 2], u: uvx + sz + sx, v: uvy, w: sx, h: sz },
                        { verts: [3, 7, 6, 2], u: uvx + sz, v: uvy + sz, w: sx, h: sy },
                        { verts: [4, 0, 1, 5], u: uvx + sz + sx + sz, v: uvy + sz, w: sx, h: sy }
                    ];

                    const positions = [];
                    const normals = [];
                    const uvs = [];
                    const indices = [];
                    let idx = 0;

                    const faceNormals = [
                        [1, 0, 0], [-1, 0, 0], [0, 0, 1], [0, 0, -1], [0, 1, 0], [0, -1, 0]
                    ];

                    faces.forEach((face, fIdx) => {
                        const triIndices = [0, 1, 2, 0, 2, 3];
                        const u1 = face.u;
                        const v1 = face.v;
                        const u2 = face.u + face.w;
                        const v2 = face.v + face.h;
                        const cornerUVs = [[u1, v2], [u2, v2], [u2, v1], [u1, v1]];

                        triIndices.forEach((vi) => {
                            const vIdx = face.verts[vi];
                            const v = verts[vIdx];
                            positions.push(v[0], v[1], -v[2]);
                            const n = faceNormals[fIdx];
                            normals.push(n[0], n[1], -n[2]);
                            const uv = cornerUVs[vi];
                            uvs.push(uv[0] / texW, 1.0 - (uv[1] / texH));
                            indices.push(idx++);
                        });
                    });

                    return { positions, normals, uvs, indices };
                },

                // 构建网格
                buildMesh(geoData, geoName, texture) {
                    const geo = geoData[geoName];
                    if (!geo || !geo.bones) return null;

                    const allPositions = [];
                    const allNormals = [];
                    const allUVs = [];
                    const allIndices = [];
                    let globalIndex = 0;

                    let texW = 64, texH = 64;
                    if (texture && texture.image) {
                        texW = texture.image.width;
                        texH = texture.image.height;
                    } else {
                        texW = geo.texturewidth || 64;
                        texH = geo.textureheight || 64;
                    }

                    geo.bones.forEach((bone) => {
                        if (bone.cubes) {
                            bone.cubes.forEach((cube) => {
                                const data = this.generateCubeGeometry(cube, texW, texH);
                                allPositions.push(...data.positions);
                                allNormals.push(...data.normals);
                                allUVs.push(...data.uvs);
                                for (let idx of data.indices) {
                                    allIndices.push(idx + globalIndex);
                                }
                                globalIndex += (data.positions.length / 3);
                            });
                        }

                        if (bone.poly_mesh) {
                            const polyMesh = bone.poly_mesh;
                            const verts = polyMesh.positions || [];
                            const norms = polyMesh.normals || [];
                            const uvData = polyMesh.uvs || [];
                            const polys = polyMesh.polys || [];
                            const normalized = polyMesh.normalized_uvs !== false;

                            if (verts.length > 0 && polys.length > 0) {
                                polys.forEach((poly) => {
                                    if (!Array.isArray(poly) || poly.length < 3) return;
                                    for (let i = 1; i < poly.length - 1; i++) {
                                        const tri = [poly[0], poly[i], poly[i + 1]];
                                        tri.forEach((corner) => {
                                            const vIdx = corner[0];
                                            const nIdx = corner[1] !== undefined ? corner[1] : 0;
                                            const uvIdx = corner[2] !== undefined ? corner[2] : 0;
                                            const v = verts[vIdx] || [0, 0, 0];
                                            allPositions.push(v[0], v[1], -v[2]);
                                            const n = norms[nIdx] || [0, 1, 0];
                                            allNormals.push(n[0], n[1], -n[2]);
                                            const uv = uvData[uvIdx] || [0, 0];
                                            let u = uv[0], v_uv = uv[1];
                                            if (normalized) { u *= texW; v_uv *= texH; }
                                            allUVs.push(u / texW, 1.0 - (v_uv / texH));
                                            allIndices.push(globalIndex++);
                                        });
                                    }
                                });
                            }
                        }
                    });

                    if (allPositions.length === 0) return null;

                    const geometry = new THREE.BufferGeometry();
                    geometry.setAttribute('position', new THREE.Float32BufferAttribute(allPositions, 3));
                    geometry.setAttribute('normal', new THREE.Float32BufferAttribute(allNormals, 3));
                    geometry.setAttribute('uv', new THREE.Float32BufferAttribute(allUVs, 2));
                    geometry.setIndex(allIndices);

                    geometry.computeBoundingBox();
                    const box = geometry.boundingBox;
                    const center = box.getCenter(new THREE.Vector3());
                    const size = box.getSize(new THREE.Vector3());

                    const posAttr = geometry.attributes.position;
                    for (let i = 0; i < posAttr.count; i++) {
                        posAttr.setXYZ(
                            i,
                            posAttr.getX(i) - center.x,
                            posAttr.getY(i) - center.y + (size.y / 2),
                            posAttr.getZ(i) - center.z
                        );
                    }
                    posAttr.needsUpdate = true;

                    return geometry;
                },

                // 初始化Three.js场景
                initScene(container) {
                    this.scene = new THREE.Scene();
                    this.scene.background = new THREE.Color(0x1a1a2e);

                    const aspect = container.clientWidth / container.clientHeight;
                    const frustumSize = 60;
                    this.camera = new THREE.OrthographicCamera(
                        frustumSize * aspect / -2,
                        frustumSize * aspect / 2,
                        frustumSize / 2,
                        frustumSize / -2,
                        0.1, 1000
                    );
                    this.camera.position.set(0, 12, 50);
                    this.camera.lookAt(0, 12, 0);

                    // 清理旧的 renderer dom 元素
                    while (container.firstChild) {
                        container.removeChild(container.firstChild);
                    }

                    this.renderer = new THREE.WebGLRenderer({ antialias: true });
                    this.renderer.setSize(container.clientWidth, container.clientHeight);
                    this.renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                    container.appendChild(this.renderer.domElement);

                    const ambient = new THREE.AmbientLight(0xffffff, 0.6);
                    this.scene.add(ambient);

                    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    dirLight.position.set(0, 40, 30);
                    this.scene.add(dirLight);

                    const gridHelper = new THREE.GridHelper(100, 10, 0x444444, 0x333333);
                    this.scene.add(gridHelper);

                    this.animate();
                },

                animate() {
                    if (!this.isOpen) return;
                    requestAnimationFrame(() => this.animate());
                    this.renderer.render(this.scene, this.camera);
                },

                // 加载并显示模型
                async viewModel(packId, skinIndex) {
                    const pack = state.skinPacks.find(p => p.id === packId);
                    if (!pack) return;

                    try {
                        // 获取皮肤信息
                        const skinsData = JSON.parse(pack.files['skins.json']._content);
                        const skin = skinsData.skins[skinIndex];
                        if (!skin) {
                            logger.add('❌ 未找到皮肤数据');
                            return;
                        }

                        const geometryName = skin.geometry;
                        const textureName = skin.texture.toLowerCase();

                        // 检查文件是否存在
                        if (!pack.files['geometry.json']) {
                            logger.add('❌ 缺少 geometry.json');
                            return;
                        }

                        // 解析geometry
                        let geoContent = pack.files['geometry.json']._content;
                        // 始终尝试自动修复 JSON 格式
                        geoContent = this.fixJsonSyntax(utils.removeCommentsAndFixGeometry(geoContent));

                        let geoData;
                        try {
                            geoData = this.parseGeometry(JSON.parse(geoContent));
                        } catch (e) {
                            // 如果还是失败，再尝试更激进的修复
                            logger.add(`⚠️ 第一次修复失败，尝试更激进的修复...`);
                            const moreFixed = utils.fixJsonSyntax(geoContent);
                            geoData = this.parseGeometry(JSON.parse(moreFixed));
                        }

                        if (!geoData[geometryName]) {
                            logger.add(`❌ 未找到模型: ${geometryName}`);
                            return;
                        }

                        // 加载贴图
                        this.currentTexture = null;
                        const textureFile = pack.files[textureName];
                        if (textureFile) {
                            const blob = textureFile.blob || new Blob([textureFile._content || '']);
                            const url = URL.createObjectURL(blob);
                            const loader = new THREE.TextureLoader();
                            this.currentTexture = await new Promise((resolve, reject) => {
                                loader.load(url, (tex) => {
                                    tex.magFilter = THREE.NearestFilter;
                                    tex.minFilter = THREE.NearestFilter;
                                    tex.flipY = false;
                                    URL.revokeObjectURL(url);
                                    resolve(tex);
                                }, undefined, reject);
                            });
                        }

                        // 显示预览区域
                        this.openViewer(packId, skinIndex, skin.localization_name || `skin_${skinIndex}`);

                        // 构建模型
                        if (this.currentMesh) {
                            this.scene.remove(this.currentMesh);
                            this.currentMesh.geometry?.dispose();
                            this.currentMesh.material?.dispose();
                        }

                        const geometry = this.buildMesh(geoData, geometryName, this.currentTexture);
                        if (!geometry) {
                            logger.add('❌ 模型构建失败');
                            return;
                        }

                        const material = new THREE.MeshStandardMaterial({
                            color: 0xffffff,
                            map: this.currentTexture,
                            transparent: true,
                            alphaTest: 0.1,
                            side: THREE.DoubleSide,
                            roughness: 0.8,
                            metalness: 0.0
                        });

                        this.currentMesh = new THREE.Mesh(geometry, material);
                        this.currentMesh.rotation.set(0, 0, 0);
                        this.scene.add(this.currentMesh);

                        logger.add(`✅ 已加载模型: ${geometryName} + ${textureName}`);

                    } catch (err) {
                        logger.add(`❌ 预览失败: ${err.message}`);
                        console.error(err);
                    }
                },

                openViewer(packId, skinIndex, skinName) {
                    const viewerId = `model-viewer-${packId}-${skinIndex}`;
                    const canvasId = `modelViewerCanvas-${packId}-${skinIndex}`;
                    const container = document.getElementById(canvasId);
                    const viewerContainer = document.getElementById(viewerId);

                    if (!container || !viewerContainer) return;

                    // 关闭其他打开的预览
                    document.querySelectorAll('.model-viewer-inline.expanded').forEach(el => {
                        if (el.id !== viewerId) el.classList.remove('expanded');
                    });

                    viewerContainer.classList.add('expanded');
                    this.isOpen = true;
                    this.initScene(container);

                    // 重置相机
                    if (this.camera) {
                        this.camera.zoom = 1;
                        this.camera.updateProjectionMatrix();
                    }

                    // 滚动到预览区域
                    viewerContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                },

                closeViewer(packId, skinIndex) {
                    const viewerId = `model-viewer-${packId}-${skinIndex}`;
                    const viewerContainer = document.getElementById(viewerId);
                    if (viewerContainer) {
                        viewerContainer.classList.remove('expanded');
                    }
                    this.isOpen = false;
                    if (this.currentMesh) {
                        this.scene.remove(this.currentMesh);
                        this.currentMesh.geometry?.dispose();
                        this.currentMesh.material?.dispose();
                        this.currentMesh = null;
                    }
                }
            };

            // UI 渲染
            const renderer = {
                packsList() {
                    const { skinPacks } = state;
                    
                    if (skinPacks.length === 0) {
                        elements.packsListContainer.style.display = 'none';
                        elements.emptyState.style.display = 'block';
                        return;
                    }

                    elements.packsListContainer.style.display = 'block';
                    elements.emptyState.style.display = 'none';
                    elements.packCount.textContent = `${skinPacks.length} 个`;

                    elements.packsList.innerHTML = skinPacks.map((pack, index) => this.createPackItem(pack, index)).join('');
                    this.attachDragEvents();
                    this.attachExpandEvents();
                },

                createPackItem(pack, index) {
                    const isReady = pack.status === 'ready';
                    const isError = pack.status === 'error';
                    
                    // 解析skins数据用于显示
                    let skins = [];
                    if (isReady && pack.files['skins.json']) {
                        try {
                            const data = JSON.parse(pack.files['skins.json']._content);
                            skins = data.skins || [];
                        } catch (e) {
                            console.error('Failed to parse skins for display:', e);
                        }
                    }

                    return `
                        <div class="pack-item ${isError ? 'error' : ''}" data-index="${index}" draggable="${!isError}" data-id="${pack.id}">
                            <div class="pack-header">
                                <div class="pack-handle" style="${isError ? 'opacity: 0.3; cursor: not-allowed;' : ''}">
                                    <i class="fas fa-grip-vertical"></i>
                                </div>
                                <div class="pack-number">${index + 1}</div>
                                <div class="pack-info">
                                    <div class="pack-name">${pack.fileName}</div>
                                    ${pack.rootPath ? `<div class="pack-path"><i class="fas fa-folder-open"></i> ${pack.rootPath}</div>` : ''}
                                    <div class="pack-meta">
                                        ${isReady
                                            ? `<span class="pack-status"><i class="fas fa-check-circle"></i> ${pack.skinCount} 个皮肤</span>`
                                            : isError
                                                ? `<span class="pack-status error"><i class="fas fa-exclamation-circle"></i> ${pack.errorMsg || '加载失败'}</span>`
                                                : `<span class="pack-status" style="background: rgba(59, 133, 38, 0.1); color: #3b8526;"><i class="fas fa-spinner fa-spin"></i> 读取中...</span>`
                                        }
                                    </div>
                                </div>
                                <div class="pack-actions">
                                    ${isReady ? `
                                        <button class="pack-btn expand" onclick="window.togglePackExpand('${pack.id}')" title="展开/收起皮肤列表">
                                            <i class="fas fa-list"></i>
                                            <span>查看</span>
                                        </button>
                                    ` : ''}
                                    <button class="pack-btn delete" onclick="window.removePack('${pack.id}')" title="删除整个皮肤包">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </div>
                            ${isReady ? `
                                <div class="skins-expandable" id="skins-expand-${pack.id}">
                                    <div class="skins-list" id="skins-list-${pack.id}">
                                        <div class="skins-list-header" id="skins-list-header-${pack.id}">
                                            <div class="skins-list-header-left">
                                                <span style="font-size: 12px; color: var(--mc-text-muted);">多选皮肤</span>
                                            </div>
                                            <button class="btn-toggle-multi" id="btn-multi-delete-${pack.id}" onclick="window.deleteSelectedSkins('${pack.id}')" disabled>
                                                <i class="fas fa-trash-alt"></i>
                                                <span>删除选中 (<span id="selected-count-${pack.id}">0</span>)</span>
                                            </button>
                                        </div>
                                        ${skins.map((skin, idx) => this.createSkinItem(pack.id, skin, idx, skins.length)).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                },

                createSkinItem(packId, skin, index, total) {
                    const animKeys = skin.animations ? Object.keys(skin.animations) : [];
                    const hasHideArmor = skin.hide_armor === true;
                    const canDelete = total > 1;

                    return `
                        <div class="skin-item" data-skin-index="${index}" id="skin-item-${packId}-${index}">
                            <div class="skin-checkbox-wrapper">
                                <input type="checkbox" class="skin-checkbox" data-pack-id="${packId}" data-skin-index="${index}" onchange="window.updateSelectedCount('${packId}')" title="选择此皮肤">
                            </div>
                            <div class="skin-index">${index + 1}</div>
                            <div class="skin-details">
                                <div class="skin-name">
                                    <i class="fas fa-user-circle" style="color: var(--mc-green);"></i>
                                    ${skin.localization_name || `skin_${index}`}
                                </div>
                                <div class="skin-geometry">
                                    <i class="fas fa-cube" style="font-size: 10px;"></i> ${skin.geometry}
                                </div>
                                <div class="skin-texture">
                                    <i class="fas fa-image" style="font-size: 10px;"></i> ${skin.texture}
                                </div>
                                ${animKeys.length > 0 ? `
                                    <div class="skin-animations">
                                        ${animKeys.slice(0, 3).map(key => `
                                            <span class="anim-tag">${key}</span>
                                        `).join('')}
                                        ${animKeys.length > 3 ? `<span class="anim-tag">+${animKeys.length - 3}</span>` : ''}
                                    </div>
                                ` : ''}
                                <div class="skin-flags">
                                    <span class="flag-tag ${hasHideArmor ? 'active' : ''}">
                                        <i class="fas fa-tshirt"></i> ${hasHideArmor ? '隐藏盔甲' : '显示盔甲'}
                                    </span>
                                    <span class="flag-tag">
                                        <i class="fas fa-tag"></i> ${skin.type || 'free'}
                                    </span>
                                </div>
                            </div>
                            <button class="skin-view-btn" onclick="window.viewSkinModel('${packId}', ${index})" title="查看3D模型">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="skin-delete-btn" onclick="window.deleteSkin('${packId}', ${index})"
                                    title="${canDelete ? '删除此皮肤' : '至少需要保留1个皮肤'}" ${!canDelete ? 'disabled' : ''}>
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                        <div class="model-viewer-inline" id="model-viewer-${packId}-${index}">
                            <div class="model-viewer-inline-content">
                                <div class="model-viewer-header">
                                    <span><i class="fas fa-cube"></i> 3D 预览</span>
                                    <button class="pack-btn delete" onclick="window.closeModelViewer('${packId}', ${index})" title="关闭">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="model-viewer-canvas" id="modelViewerCanvas-${packId}-${index}"></div>
                            </div>
                        </div>
                    `;
                },

                attachDragEvents() {
                    const items = elements.packsList.querySelectorAll('.pack-item:not(.error)');
                    items.forEach(item => {
                        item.addEventListener('dragstart', e => {
                            state.dragStartIndex = +item.dataset.index;
                            item.classList.add('dragging');
                            e.dataTransfer.effectAllowed = 'move';
                        });
                        item.addEventListener('dragend', () => item.classList.remove('dragging'));
                        item.addEventListener('dragover', e => e.preventDefault());
                        item.addEventListener('dragenter', () => item.classList.add('drag-over'));
                        item.addEventListener('dragleave', () => item.classList.remove('drag-over'));
                        item.addEventListener('drop', e => {
                            e.stopPropagation();
                            const endIndex = +item.dataset.index;
                            if (state.dragStartIndex !== endIndex) {
                                const [moved] = state.skinPacks.splice(state.dragStartIndex, 1);
                                state.skinPacks.splice(endIndex, 0, moved);
                                logger.add(`🔄 已调整顺序: 将第 ${state.dragStartIndex + 1} 位移至第 ${endIndex + 1} 位`);
                                this.packsList();
                            }
                        });
                    });
                },

                attachExpandEvents() {
                    // 点击展开按钮的事件通过onclick内联处理
                },

                updateUI() {
                    const readyPacks = state.skinPacks.filter(p => p.status === 'ready');
                    const allReady = readyPacks.length === state.skinPacks.length && state.skinPacks.length >= 2;
                    
                    elements.mergeBtn.disabled = !allReady || state.mergeInProgress;
                    elements.mergeBtnText.textContent = state.skinPacks.length < 2 
                        ? `请至少上传 2 个皮肤包 (${state.skinPacks.length}/2)` 
                        : `开始合并 ${state.skinPacks.length} 个皮肤包`;
                },

                refreshPackSkins(packId) {
                    // 只刷新指定pack的皮肤列表部分
                    const pack = state.skinPacks.find(p => p.id === packId);
                    if (!pack || !pack.files['skins.json']) return;

                    const skinsListEl = document.getElementById(`skins-list-${packId}`);
                    if (!skinsListEl) return;

                    try {
                        const data = JSON.parse(pack.files['skins.json']._content);
                        const skins = data.skins || [];
                        pack.skinCount = skins.length;
                        
                        // 更新头部计数
                        const packItem = document.querySelector(`[data-id="${packId}"]`);
                        if (packItem) {
                            const statusEl = packItem.querySelector('.pack-status');
                            if (statusEl) {
                                statusEl.innerHTML = `<i class="fas fa-check-circle"></i> ${pack.skinCount} 个皮肤`;
                            }
                        }

                        // 保留头部栏（多选删除工具栏），只刷新皮肤列表
                        const headerEl = document.getElementById(`skins-list-header-${packId}`);
                        const headerHTML = headerEl ? headerEl.outerHTML : '';

                        skinsListEl.innerHTML = headerHTML + skins.map((skin, idx) => this.createSkinItem(packId, skin, idx, skins.length)).join('');

                        // 重新绑定 checkbox 事件和更新计数
                        window.updateSelectedCount(packId);
                    } catch (e) {
                        console.error('Failed to refresh skins:', e);
                    }
                }
            };

            // 事件处理
            const events = {
                init() {
                    // 上传事件
                    elements.uploadZone.addEventListener('click', () => elements.fileInput.click());
                    elements.uploadZone.addEventListener('dragover', e => {
                        e.preventDefault();
                        elements.uploadZone.classList.add('dragover');
                    });
                    elements.uploadZone.addEventListener('dragleave', () => elements.uploadZone.classList.remove('dragover'));
                    elements.uploadZone.addEventListener('drop', e => {
                        e.preventDefault();
                        elements.uploadZone.classList.remove('dragover');
                        this.handleFiles(Array.from(e.dataTransfer.files).filter(f => f.name.endsWith('.zip')));
                    });
                    elements.fileInput.addEventListener('change', e => {
                        this.handleFiles(Array.from(e.target.files));
                        elements.fileInput.value = '';
                    });

                    // 预设按钮
                    document.querySelectorAll('.preset-pill').forEach(btn => {
                        btn.addEventListener('click', () => {
                            btn.classList.toggle('active');
                            const presetId = btn.dataset.preset;
                            const isActive = btn.classList.contains('active');
                            logger.add(`${isActive ? '✅' : '❌'} ${isActive ? '已启用' : '已关闭'}预设${presetId}：${PRESET_CONFIGS[presetId].name}`);
                            this.applyPresets();
                        });
                    });

                    // 合并按钮
                    elements.mergeBtn.addEventListener('click', () => this.startMerge());

                    // 全局函数
                    window.removePack = id => {
                        const idx = state.skinPacks.findIndex(p => p.id === id);
                        if (idx !== -1) {
                            const pack = state.skinPacks[idx];
                            state.skinPacks.splice(idx, 1);
                            state.modelTextureRelations.delete(pack.id);
                            logger.add(`🗑️ 已移除 ${pack.fileName}`);
                            renderer.packsList();
                            renderer.updateUI();
                        }
                    };

                    window.togglePackExpand = packId => {
                        const expandEl = document.getElementById(`skins-expand-${packId}`);
                        if (expandEl) {
                            expandEl.classList.toggle('expanded');
                            const btn = document.querySelector(`[data-id="${packId}"] .pack-btn.expand`);
                            if (btn) {
                                const isExpanded = expandEl.classList.contains('expanded');
                                btn.innerHTML = isExpanded ? 
                                    '<i class="fas fa-chevron-up"></i><span>收起</span>' : 
                                    '<i class="fas fa-list"></i><span>查看</span>';
                            }
                        }
                    };

                    window.deleteSkin = (packId, skinIndex) => {
                        if (skinDeleter.deleteSkin(packId, skinIndex)) {
                            renderer.refreshPackSkins(packId);
                        }
                    };

                    // 多选删除相关函数
                    window.updateSelectedCount = (packId) => {
                        const checkboxes = document.querySelectorAll(`.skin-checkbox[data-pack-id="${packId}"]`);
                        const selectedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
                        const countDisplay = document.getElementById(`selected-count-${packId}`);
                        const deleteBtn = document.getElementById(`btn-multi-delete-${packId}`);

                        if (countDisplay) {
                            countDisplay.textContent = selectedCount;
                        }
                        if (deleteBtn) {
                            deleteBtn.disabled = selectedCount === 0;
                        }

                        // 更新选中项的高亮状态
                        checkboxes.forEach(cb => {
                            const skinIndex = cb.dataset.skinIndex;
                            const skinItem = document.getElementById(`skin-item-${packId}-${skinIndex}`);
                            if (skinItem) {
                                skinItem.classList.toggle('multi-selected', cb.checked);
                            }
                        });
                    };

                    window.deleteSelectedSkins = (packId) => {
                        const checkboxes = document.querySelectorAll(`.skin-checkbox[data-pack-id="${packId}"]`);
                        const selectedIndices = Array.from(checkboxes)
                            .filter(cb => cb.checked)
                            .map(cb => parseInt(cb.dataset.skinIndex))
                            .sort((a, b) => b - a); // 从大到小删除，避免索引偏移

                        if (selectedIndices.length === 0) return;

                        const pack = state.skinPacks.find(p => p.id === packId);
                        if (!pack || !pack.files['skins.json']) return;

                        const skinsData = JSON.parse(pack.files['skins.json']._content);
                        const remainingSkins = skinsData.skins.length - selectedIndices.length;

                        if (remainingSkins < 1) {
                            logger.add(`⚠️ 无法删除：${pack.fileName} 至少需要保留 1 个皮肤`);
                            return;
                        }

                        // 批量删除皮肤
                        let deletedCount = 0;
                        for (const skinIndex of selectedIndices) {
                            const deletedSkin = skinsData.skins[skinIndex];
                            if (deletedSkin) {
                                skinDeleter.cleanupUnusedTexture(pack, deletedSkin.texture, 
                                    skinsData.skins.filter((_, idx) => !selectedIndices.includes(idx)));
                                deletedCount++;
                            }
                        }

                        // 过滤掉选中的皮肤
                        skinsData.skins = skinsData.skins.filter((_, idx) => !selectedIndices.includes(idx));
                        
                        // 更新文件内容
                        pack.files['skins.json']._content = JSON.stringify(skinsData);
                        pack.skinCount = skinsData.skins.length;

                        logger.add(`🗑️ 已批量删除 ${deletedCount} 个皮肤 (${pack.fileName})`);
                        renderer.refreshPackSkins(packId);
                    };

                    // 模型预览全局函数
                    window.viewSkinModel = (packId, skinIndex) => {
                        window.ModelViewer.viewModel(packId, skinIndex);
                    };

                    window.closeModelViewer = (packId, skinIndex) => {
                        window.ModelViewer.closeViewer(packId, skinIndex);
                    };
                },

                async handleFiles(files) {
                    const newPacks = [];
                    
                    for (const file of files) {
                        if (!file.name.endsWith('.zip')) continue;
                        
                        const existingIdx = state.skinPacks.findIndex(p => p.fileName === file.name);
                        if (existingIdx !== -1) {
                            logger.add(`⚠️ ${file.name} 已存在，将替换旧版本`);
                            state.skinPacks.splice(existingIdx, 1);
                        }

                        newPacks.push({
                            id: `${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            fileName: file.name,
                            name: utils.getSafeFileName(file.name.replace('.zip', '')),
                            files: {},
                            status: 'loading',
                            rootPath: ''
                        });
                    }

                    state.skinPacks.push(...newPacks);
                    renderer.packsList();

                    await Promise.all(newPacks.map(async pack => {
                        const file = files.find(f => f.name === pack.fileName);
                        if (!file) return;

                        try {
                            logger.add(`正在读取 ${pack.fileName}...`);
                            await fileHandler.extractZip(file, pack);
                            
                            const missing = CORE_FILES.filter(f => !pack.files[f]);
                            if (missing.length) throw new Error(`缺少核心文件: ${missing.join(' ')}`);
                            
                            pack.skinCount = utils.countSkins(await pack.files['skins.json'].content);
                            pack.status = 'ready';
                            logger.add(`✅ ${pack.fileName} 已加载 (${pack.skinCount} 个皮肤)`);
                            if (pack.rootPath) logger.add(`   📁 检测到子文件夹结构: ${pack.rootPath}`);
                        } catch (err) {
                            pack.status = 'error';
                            pack.errorMsg = err.message;
                            logger.add(`❌ ${pack.fileName} 读取失败: ${err.message}`);
                        }
                        renderer.packsList();
                    }));

                    renderer.updateUI();
                },

                applyPresets() {
                    const activePresets = document.querySelectorAll('.preset-pill.active');
                    const settings = { compatibleRenameModel: false, simplifyNaming: false, replaceUuid: false, addHideArmor: false, fixComments: false, outputMcpack: false };
                    
                    activePresets.forEach(btn => {
                        Object.assign(settings, PRESET_CONFIGS[btn.dataset.preset].settings);
                    });

                    Object.entries(settings).forEach(([key, val]) => {
                        const el = document.getElementById(key);
                        if (el) el.checked = val;
                    });
                },

                async startMerge() {
                    if (state.mergeInProgress) return;
                    state.mergeInProgress = true;
                    renderer.updateUI();
                    
                    elements.progressContainer.style.display = 'block';
                    elements.resultContainer.style.display = 'none';
                    logger.add('=== 开始合并皮肤包 ===');
                    logger.add(`📦 共合并 ${state.skinPacks.length} 个皮肤包`);

                    try {
                        utils.updateProgress(10, '读取核心文件...');
                        const packsData = await Promise.all(state.skinPacks.map(async (pack, i) => ({
                            pack,
                            core: await fileHandler.loadCore(pack.files, `包${i + 1}(${pack.name})`)
                        })));

                        utils.updateProgress(25, '扫描模型-贴图关联关系...');
                        packsData.forEach(({ pack, core }) => relationScanner.scan(core, pack.id));

                        utils.updateProgress(40, elements.compatibleRenameModel.checked ? '执行重名模型兼容命名...' : 
                            (elements.simplifyNaming.checked ? '执行命名简化...' : '处理重复字段...'));

                        const result = await this.processPacks(packsData);
                        
                        if (elements.addHideArmor.checked) {
                            utils.updateProgress(60, '处理隐藏盔甲...');
                            result.skins = result.skins.map(s => s.type === 'free' && !s.hide_armor ? { ...s, hide_armor: true } : s);
                            const count = result.skins.filter(s => s.hide_armor).length;
                            if (count) logger.add(`🛡️ 已为 ${count} 个皮肤启用隐藏盔甲`);
                        }

                        // 处理 cape 重命名
                        utils.updateProgress(65, '处理披风重命名...');
                        const capeFiles = this.processCapeRename(result, state.skinPacks);

                        utils.updateProgress(70, '合并文件...');
                        const outputFiles = this.buildOutputFiles(result, packsData[0].core['manifest.json']);

                        // 添加 cape 文件到输出
                        capeFiles.forEach((content, name) => {
                            outputFiles[name] = content;
                        });

                        utils.updateProgress(80, '收集贴图文件...');
                        this.collectTextures(outputFiles, state.skinPacks);

                        utils.updateProgress(90, '生成压缩包...');
                        const zipBlob = await this.generateZip(outputFiles);
                        const suffix = elements.outputMcpack.checked ? '.mcpack' : '.zip';
                        const fileName = `merged_${state.skinPacks.length}packs_${Date.now()}${suffix}`;

                        utils.updateProgress(100, '完成！');
                        elements.resultContainer.style.display = 'block';
                        elements.downloadBtn.onclick = () => saveAs(zipBlob, fileName);
                        logger.add(`✅ 合并成功！共 ${result.skins.length} 个皮肤`);

                    } catch (err) {
                        logger.add(`❌ 错误: ${err.message}`);
                        console.error(err);
                    } finally {
                        state.mergeInProgress = false;
                        renderer.updateUI();
                    }
                },

                async processPacks(packsData) {
                    const allSkins = [];
                    const mergedGeo = {};
                    
                    for (let i = 0; i < packsData.length; i++) {
                        const { pack, core } = packsData[i];
                        const startIdx = allSkins.length;
                        let result;

                        if (elements.compatibleRenameModel.checked) {
                            result = namingHandler.compatibleSimplify(core, pack.id, startIdx);
                        } else if (elements.simplifyNaming.checked) {
                            result = namingHandler.simplifySingle(core, pack.id, startIdx);
                        } else {
                            const prefix = utils.getSafeFileName(pack.name).substring(0, 8) || `pack${i+1}`;
                            result = namingHandler.modifyDuplicate(core, allSkins, prefix);
                        }

                        allSkins.push(...result.modifiedSkins);
                        
                        Object.entries(core['geometry.json']).forEach(([key, val]) => {
                            mergedGeo[result.geoRenameMap.get(key) || key] = val;
                        });

                        pack.geoRenameMap = result.geoRenameMap;
                        pack.textureMap = result.textureMap;
                    }

                    return { skins: allSkins, geometry: mergedGeo };
                },

                /**
                 * 处理 cape 文件重命名
                 * 检测 skins.json 中的 cape 字段，将对应的 png 文件按顺序重命名为 cape1.png, cape2.png...
                 */
                processCapeRename(result, packs) {
                    const capeMap = new Map(); // 旧 cape 名 -> 新 cape 名
                    const capeFiles = new Map(); // 用于存储 cape 文件内容
                    let capeCounter = 1;

                    // 收集所有需要重命名的 cape（只要是 png 文件就重命名）
                    result.skins.forEach(skin => {
                        if (skin.cape && skin.cape.endsWith('.png')) {
                            const capeLower = skin.cape.toLowerCase();
                            if (!capeMap.has(capeLower)) {
                                const newCapeName = `cape${capeCounter}.png`;
                                capeMap.set(capeLower, newCapeName);
                                capeCounter++;
                            }
                        }
                    });

                    // 更新 skins 中的 cape 字段
                    result.skins.forEach(skin => {
                        if (skin.cape && capeMap.has(skin.cape.toLowerCase())) {
                            skin.cape = capeMap.get(skin.cape.toLowerCase());
                        }
                    });

                    // 收集 cape 文件并建立映射
                    packs.forEach(pack => {
                        Object.entries(pack.files).forEach(([name, file]) => {
                            const nameLower = name.toLowerCase();
                            if (capeMap.has(nameLower)) {
                                const newCapeName = capeMap.get(nameLower);
                                pack.textureMap.set(name, newCapeName);
                                capeFiles.set(newCapeName, file.blob || file);
                                logger.add(`🦅 Cape 重命名：${name} → ${newCapeName}`);
                            }
                        });
                    });

                    return capeFiles;
                },

                buildOutputFiles(result, manifest) {
                    if (elements.replaceUuid.checked && manifest) {
                        manifest.header.uuid = utils.generateUUID();
                        if (manifest.modules) manifest.modules[0].uuid = utils.generateUUID();
                    }

                    // 自定义格式化 geometry.json，在最后一个 geometry 对象的大括号后也添加逗号
                    const geometryKeys = Object.keys(result.geometry);
                    let geometryJsonStr = '';

                    geometryKeys.forEach((key) => {
                        const val = result.geometry[key];
                        const geoStr = `    "${key}": ${JSON.stringify(val).replace(/^/gm, '    ')}`;
                        geometryJsonStr += geoStr + ',\n';
                    });

                    const finalGeometryJson = `{\n${geometryJsonStr}}`;

                    return {
                        'manifest.json': JSON.stringify(manifest),
                        'skins.json': JSON.stringify({ skins: result.skins }),
                        'geometry.json': finalGeometryJson
                    };
                },

                collectTextures(outputFiles, packs) {
                    packs.forEach(pack => {
                        Object.entries(pack.files).forEach(([name, file]) => {
                            if (name.endsWith('.png') || name.endsWith('.jpg')) {
                                const newName = pack.textureMap.get(name) || name;
                                outputFiles[newName] = file.blob || file;
                            }
                        });
                    });
                },

                async generateZip(files) {
                    const zip = new JSZip();
                    Object.entries(files).forEach(([name, content]) => {
                        zip.file(name, typeof content === 'string' ? content : content);
                    });
                    return await zip.generateAsync({ type: 'blob', compression: 'DEFLATE' });
                }
            };

            // 初始化
            events.init();
        })();
    </script>

    <!-- 移动端底部导航栏 -->
    <nav class="mobile-nav-main">
        <a href="index.html" class="mobile-nav-item active">
            <i class="fas fa-layer-group"></i>
            <span>合并工具</span>
        </a>
        <a href="skinstudio/index.html" class="mobile-nav-item mobile-nav-studio">
            <i class="fas fa-palette"></i>
            <span>皮肤工作室</span>
        </a>
    </nav>

    <style>
        /* 移动端底部导航栏样式 - 优化设计 */
        .mobile-nav-main {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(27, 27, 27, 0.98), rgba(42, 42, 42, 0.95));
            border-top: 3px solid var(--mc-border);
            z-index: 1000;
            justify-content: space-evenly;
            align-items: stretch;
            padding: 4px 4px 0;
            padding-bottom: env(safe-area-inset-bottom);
            height: calc(60px + env(safe-area-inset-bottom));
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.4);
        }

        .mobile-nav-main .mobile-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 16px;
            color: var(--mc-text-muted);
            text-decoration: none;
            transition: all 0.2s ease;
            min-width: 0;
            flex: 1;
            border-radius: 0;
            position: relative;
            -webkit-tap-highlight-color: transparent;
            border: none;
            background: transparent;
        }

        .mobile-nav-main .mobile-nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--mc-green), transparent);
            transition: transform 0.25s ease;
            border-radius: 0 0 3px 3px;
        }

        .mobile-nav-main .mobile-nav-item.active {
            color: var(--mc-green);
        }

        .mobile-nav-main .mobile-nav-item.active::before {
            transform: translateX(-50%) scaleX(1);
        }

        .mobile-nav-main .mobile-nav-item:active {
            transform: scale(0.9);
        }

        .mobile-nav-main .mobile-nav-item i {
            font-size: 24px;
            margin-bottom: 4px;
            transition: all 0.2s ease;
        }

        .mobile-nav-main .mobile-nav-item.active i {
            transform: scale(1.1);
            text-shadow: 0 0 8px rgba(59, 133, 38, 0.5);
        }

        .mobile-nav-main .mobile-nav-item span {
            font-size: 11px;
            font-weight: 600;
            letter-spacing: 0.2px;
            transition: all 0.2s ease;
        }

        .mobile-nav-main .mobile-nav-item.active span {
            color: var(--mc-green);
        }

        /* 皮肤工作室按钮特殊样式 - 更突出美观 */
        .mobile-nav-studio {
            position: relative;
            border-left: 1px solid rgba(255, 255, 255, 0.1);
        }

        .mobile-nav-studio i {
            font-size: 26px !important;
            transition: all 0.2s ease;
        }

        .mobile-nav-studio:active {
            transform: scale(0.92);
            background: linear-gradient(135deg, rgba(59, 133, 38, 0.25) 0%, rgba(59, 133, 38, 0.15) 100%);
        }

        .mobile-nav-studio:active i {
            transform: scale(1.1);
            background: linear-gradient(135deg, var(--mc-green) 0%, #5cb85c 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .mobile-nav-studio:active span {
            color: var(--mc-green);
            font-weight: 700;
        }

        .mobile-nav-studio::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%) scaleX(0);
            width: 50px;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--mc-green), transparent);
            transition: transform 0.3s ease;
            border-radius: 0 0 3px 3px;
        }

        .mobile-nav-studio:active::before {
            transform: translateX(-50%) scaleX(1);
        }

        @media (max-width: 600px) {
            .mobile-nav-main {
                display: flex;
            }
        }
    </style>
</body>
</html>

